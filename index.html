<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Electricity Usage Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div>
      <h1>Electricity Usage Dashboard</h1>
      <p class="subtitle">Provincial electricity usage overview</p>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats">
    <div class="card">
      <span>Total Consumption</span>
      <h2 id="totalConsumption" class="blue">-</h2>
    </div>
    <div class="card">
      <span>Total Active Users</span>
      <h2 id="totalUsers">-</h2>
    </div>
    <div class="card">
      <span>Avg Usage / Province</span>
      <h2 id="avgUsage" class="green">-</h2>
    </div>
    <div class="card">
      <span>Top Province</span>
      <h2 id="topProvince" class="orange">-</h2>
    </div>
  </div>

  <!-- CHART -->
  <div class="card">
    <div class="chart-header">
      <h3>Electricity Usage by Province</h3>

      <div class="slider-box">
        <span>Scroll</span>
        <input id="chartSlider" type="range" min="0" value="0">
      </div>
    </div>

    <div id="barChart" class="bar-chart"></div>
  </div>

  <!-- TABLE -->
  <div class="card">
    <h3>Provincial Data Breakdown</h3>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Province</th>
            <th>Total Users</th>
            <th>Consumption (kWh)</th>
            <th>Usage / User</th>
          </tr>
        </thead>
        <tbody id="provinceTable"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const VISIBLE_COUNT = 10; // จำนวนจังหวัดที่โชว์ต่อครั้ง
let provinces = [];

async function loadData() {
  const usageJson = await (await fetch('electricity_usages_en.json')).json();
  const userData  = await (await fetch('electricity_users_en.json')).json();

  provinces = usageJson.Sheet1.map(p => {
    const consumption = Object.keys(p)
      .filter(k => k.endsWith('_kwh'))
      .reduce((s,k)=>s+(Number(p[k])||0),0);

    return { name: p.province_name, consumption };
  });

  provinces.sort((a,b)=>b.consumption-a.consumption);

  // stats
  const totalConsumption = provinces.reduce((s,p)=>s+p.consumption,0);
  document.getElementById('totalConsumption').textContent =
    totalConsumption.toLocaleString() + ' kWh';

  document.getElementById('avgUsage').textContent =
    Math.round(totalConsumption / provinces.length).toLocaleString() + ' kWh';

  document.getElementById('topProvince').textContent = provinces[0].name;

  const totalUsers = userData.reduce((s,p)=>{
    return s + Object.keys(p)
      .filter(k=>k.endsWith('_count'))
      .reduce((x,k)=>x+(Number(p[k])||0),0);
  },0);
  document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();

  // slider setup
  const slider = document.getElementById('chartSlider');
  slider.max = provinces.length - VISIBLE_COUNT;
  slider.addEventListener('input', () => renderChart(+slider.value));

  renderChart(0);
  renderTable(userData);
}

function renderChart(startIndex) {
  const barChart = document.getElementById('barChart');
  barChart.innerHTML = '';

  const slice = provinces.slice(startIndex, startIndex + VISIBLE_COUNT);
  const max = slice[0].consumption;

  slice.forEach(p => {
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = (p.consumption / max * 100) + '%';
    bar.innerHTML = `<span>${p.name}</span>`;
    barChart.appendChild(bar);
  });
}

function renderTable(userData) {
  const tbody = document.getElementById('provinceTable');

  provinces.forEach(p => {
    const users = userData.find(u => u.province_name === p.name);
    const userCount = users
      ? Object.keys(users)
          .filter(k=>k.endsWith('_count'))
          .reduce((s,k)=>s+(Number(users[k])||0),0)
      : 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${userCount.toLocaleString()}</td>
      <td>${p.consumption.toLocaleString()}</td>
      <td class="blue">
        ${userCount ? Math.round(p.consumption/userCount).toLocaleString() : '-'}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

loadData();
</script>

</body>
</html>
